# 给开发者的回复 - 项目需求确认

你好！感谢你非常专业和详尽的问题拆解。你的分析非常到位，这些问题确实都是项目落地的关键点。下面是我对每个问题的明确回复：

---

## 1. 策略范围

### 1.1 初期实现策略

我们**不需要**实现全部策略。请优先聚焦以下三个核心策略：

1.  **趋势跟踪 (Trend Following)** - EMA(9/21/55) 多头/空头排列策略
2.  **网格交易 (Grid Trading)** - 等差网格，震荡市场专用
3.  **突破策略 (Breakout Strategy)** - 关键位突破 + 布林带挤压确认

这三个策略在当前市场环境下代表性强，也适合合约交易的特性。

### 1.2 链上策略处理

链上策略（如交易所流入流出、巨鲸地址监控）**暂时不开发**。你提到的"缺数据时自动降级"方案非常好，我们可以将其他未实现的策略（如动量、均值回归、链上信号等）都暂时降级为 `HOLD` 或不执行任何操作。

### 1.3 策略架构设计

虽然我们只启用 3 个策略，但在代码架构层面，请保留完整的策略库框架（包括所有 10 类策略的接口定义）。这样未来可以逐步启用其他策略，而不需要重构核心架构。

---

## 2. 前端实盘交易

### 2.1 核心功能

你建议的"**手动下单 + 平仓 + 取消 + 仓位/订单面板**"作为第一版功能非常合适。这是实盘交易的基础，也是用户最需要的功能。

### 2.2 风控功能 (重要!)

请务必加上 **止盈止损 (TP/SL)** 功能。这是合约交易的刚需，也是风险管理的核心。具体要求：

*   支持设置固定价格止盈止损
*   支持设置百分比止盈止损
*   支持移动止损 (Trailing Stop)
*   止损触发后应立即市价平仓，确保执行

### 2.3 安全鉴权

我完全同意必须有安全措施。请采用 **简易 Token 鉴权方案**：

*   在 `.env` 中配置 `API_WRITE_TOKEN`
*   所有写操作（下单、平仓、取消）必须在请求头中携带正确的 Token
*   默认启用 `API_WRITE_ENABLED=true`，但必须配合 Token 使用
*   如果 Token 不匹配，返回 `401 Unauthorized`

### 2.4 前端界面建议

前端应包含以下核心模块：

1.  **实时行情面板** - 显示当前价格、24h 涨跌幅、成交量、资金费率
2.  **手动下单面板** - 支持市价单/限价单，设置杠杆、止盈止损
3.  **持仓管理面板** - 显示当前持仓、未实现盈亏、强平价格
4.  **订单管理面板** - 显示活跃订单、历史订单，支持取消
5.  **风险监控面板** - 显示账户权益、可用保证金、风险率

---

## 3. LLM 回测

### 3.1 触发频率

LLM 策略选择的频率，我们定为：

*   **优先方案**: **"仅在市场结构 (Regime) 发生变化时触发"**。也就是说，当市场从"趋势"切换到"震荡"，或从"震荡"切换到"突破"时，LLM 才会重新评估并选择策略。
*   **降级方案**: 如果实现起来复杂，可以先降级为 **"每 24 根 K 线（4h 周期下为 4 天）重新评估一次"**。这样既不会过于频繁，也能及时响应市场变化。

### 3.2 调用方式

使用现有的 **LLM Provider 在线调用** 即可，暂时不需要做离线缓存。优先保证快速实现，后续如果发现调用成本过高或延迟问题，再考虑优化。

### 3.3 决策缓存

为了回测的可复现性和成本控制，建议将 LLM 的决策结果缓存到数据库中。具体方案：

*   在数据库中新增 `llm_decisions` 表，记录每次 LLM 决策的时间、市场状态、选择的策略、置信度、推理过程等。
*   回测时，如果缓存中已有该时间点的决策，直接使用缓存；否则调用 LLM 并写入缓存。

---

## 4. 总结与确认

综合以上讨论，我们的 **第一阶段目标** 是：

1.  **策略层**: 实现趋势、网格、突破三个策略，其他策略降级为 `HOLD`。
2.  **前端层**: 具备带止盈止损的手动交易面板，支持 Token 鉴权。
3.  **LLM 层**: 按市场结构变化或固定周期（24 根 K 线）进行在线决策，并缓存结果。
4.  **风控层**: 强制执行 `max_positions_per_symbol = 1`，HIGH_VOL 时禁用震荡与网格，每日最大亏损触发后停止开新仓。

这个方向非常清晰，也符合"快速落地、逐步迭代"的原则。请按此方案开始推进吧！

如果在开发过程中遇到任何技术问题或需要进一步澄清的地方，随时沟通。

---

**附注**: 我已经将策略库文档更新为 `BITCOIN_STRATEGY_LIBRARY_v2.md`，这是一个更聚焦、更适合当前阶段的版本。请参考这个版本进行开发。

祝开发顺利！
