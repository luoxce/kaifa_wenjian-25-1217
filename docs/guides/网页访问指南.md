# 网页访问指南

## 🚀 快速启动

### 第零步：准备数据（首次使用或回测系统需要）

#### 下载1小时数据（基础功能）

```bash
# 下载1小时历史数据（默认）
python update_market_data.py --initial-sync
```

#### 下载15分钟数据（回测系统需要）

**重要**：如果使用回测系统，必须下载15分钟数据！

```bash
# 下载15分钟历史数据（回测系统必需）
python update_market_data.py --initial-sync --timeframe 15m --days 365

# 查看数据统计，确认15m数据已下载
python update_market_data.py --stats
```

**注意**：
- 15m数据量较大：365天约35,040根K线
- 下载时间：根据网络情况，可能需要几分钟到十几分钟
- 回测系统使用15m作为基准周期，必须下载15m数据

### 第一步：启动FastAPI服务器

在项目根目录（`kaifa_wenjian`）下运行：

```bash
# 方式1：直接使用uvicorn
uvicorn fastapi_app:app --reload

# 方式2：指定端口和主机（允许局域网访问）
uvicorn fastapi_app:app --reload --host 0.0.0.0 --port 8000

# 方式3：后台运行（Linux/Mac）
nohup uvicorn fastapi_app:app --reload --host 0.0.0.0 --port 8000 > server.log 2>&1 &
```

**输出示例：**
```
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

### 第二步：打开网页

在浏览器中访问：

- **本地访问**：http://localhost:8000 或 http://127.0.0.1:8000
- **局域网访问**：http://你的IP地址:8000

---

## 📱 网页功能说明

### 1. Account Overview（账户概览）

显示账户信息：
- Account Equity（账户权益）
- Available Cash（可用资金）
- Open Notional（持仓名义价值）
- Orders（最近一分钟订单数）
- Active Positions（活跃持仓列表）

**刷新**：点击右上角"Refresh"按钮

---

### 2. Market Watch（市场观察）

显示市场数据：
- 实时价格图表（Chart.js）
- 技术指标（EMA、RSI、MACD等）
- 支持切换时间框架（1h、4h、1d等）

**刷新**：勾选"Live via OKX"后点击"Refresh"

---

### 3. Decision Runner（决策运行器）⭐

**这是核心功能！可以运行包含技术分析的决策。**

#### 配置选项：

- ✅ **Offline**：使用缓存的决策（不调用LLM）
- ✅ **Refresh market before run**：运行前刷新市场数据
- ✅ **Save output artifacts**：保存输出文件
- ✅ **Strategy**：选择策略（Conservative/Balanced/Aggressive）
- ✅ **Timeframe**：选择时间框架（1h、4h、1d等）
- ✅ **Symbol**：选择交易对（BTC、ETH等）

#### 使用方法：

1. **配置选项**：根据需要勾选或选择参数
2. **点击"Run Decision"**：立即运行一次决策
3. **查看结果**：在"Latest Result"区域查看：
   - 决策动作（OPEN_LONG/OPEN_SHORT/CLOSE_POSITION/HOLD）
   - 风险检查结果（PASSED/FAILED）
   - 技术分析报告（如果生成成功）
   - Prompt和原始LLM响应

#### 自动运行：

- 点击"Start Auto Run (15 min)"：每15分钟自动运行一次
- 再次点击可停止自动运行

---

### 4. Recent History（最近历史）

显示最近的决策历史：
- 时间戳
- 决策动作
- 风险检查状态（PASSED/FAILED）
- 点击"View details"查看完整JSON

---

## 🎯 使用技术分析功能

### 在网页中使用技术分析

1. **确保数据库有数据**：
   ```bash
   python update_market_data.py --initial-sync
   ```

2. **启动服务器**：
   ```bash
   uvicorn fastapi_app:app --reload
   ```

3. **打开网页**：http://localhost:8000

4. **运行决策**：
   - 在"Decision Runner"区域
   - 勾选"Refresh market before run"（可选）
   - 选择Strategy和Timeframe
   - 点击"Run Decision"

5. **查看技术分析**：
   - 在"Latest Result"区域
   - 展开"Prompt Sent to LLM"查看完整prompt（包含技术分析报告）
   - 展开"Raw LLM Response"查看LLM的原始响应

---

## 🔧 配置要求

### 环境变量

确保`.env`文件包含：

```env
# DeepSeek API（必需）
DEEPSEEK_API_KEY=your_api_key_here

# OKX API（可选，但推荐用于获取实时数据）
OKX_API_KEY=your_api_key
OKX_API_SECRET=your_secret
OKX_PASSWORD=your_passphrase

# 代理（如果需要）
OKX_HTTP_PROXY=http://127.0.0.1:33210
OKX_HTTPS_PROXY=http://127.0.0.1:33210
```

### Python依赖

确保已安装所有依赖：

```bash
pip install -r requirements.txt
```

---

## 📊 网页界面预览

### 主要区域

```
┌─────────────────────────────────────────┐
│  Alpha Arena - Trading Control Center   │
│  [Refresh All] [README]                 │
└─────────────────────────────────────────┘

┌──────────────┐  ┌──────────────┐
│ Account      │  │ Market       │
│ Overview     │  │ Watch        │
└──────────────┘  └──────────────┘

┌──────────────┐  ┌──────────────┐
│ Decision     │  │ Recent       │
│ Runner ⭐    │  │ History      │
└──────────────┘  └──────────────┘
```

---

## 🐛 常见问题

### 问题1：无法访问网页

**症状**：浏览器显示"无法访问此网站"

**解决方案**：
1. 检查服务器是否已启动（查看终端输出）
2. 确认端口8000未被占用
3. 检查防火墙设置
4. 尝试使用 `http://127.0.0.1:8000` 而不是 `localhost`

### 问题2：技术分析显示失败

**症状**：决策运行但提示"Technical analysis generation failed"

**解决方案**：
```bash
# 检查数据库是否有数据
python update_market_data.py --stats

# 如果没有数据，执行初始同步
python update_market_data.py --initial-sync
```

### 问题3：LLM调用失败

**症状**：决策运行时显示错误"DEEPSEEK_API_KEY missing"

**解决方案**：
1. 检查`.env`文件中是否配置了`DEEPSEEK_API_KEY`
2. 或者使用Offline模式（勾选"Offline"选项）

### 问题4：市场数据无法获取

**症状**：Market Watch显示错误

**解决方案**：
1. 检查网络连接
2. 如果使用代理，确认`.env`中的代理配置正确
3. 可以暂时不勾选"Live via OKX"，使用本地缓存数据

---

## 🎨 界面功能详解

### Decision Runner 详细说明

#### 运行决策的完整流程：

1. **用户配置选项**
   - 选择策略（保守/平衡/激进）
   - 选择时间框架（1h、4h等）
   - 选择交易对（BTC、ETH等）
   - 勾选是否刷新市场数据

2. **系统处理**：
   - 从数据库加载账户数据
   - 刷新市场数据（如果勾选）
   - **生成技术分析报告**（从数据库读取数据）
   - 将技术分析注入prompt
   - 调用LLM生成决策
   - 进行风险检查

3. **显示结果**：
   - 决策动作和参数
   - 风险检查结果
   - 完整的prompt（包含技术分析）
   - LLM原始响应

---

## 📝 API端点说明

网页使用的API端点：

- `GET /api/account` - 获取账户信息
- `GET /api/market` - 获取市场数据
- `POST /api/decision/run` - 运行决策（包含技术分析）⭐
- `GET /api/history` - 获取历史记录

---

## 💡 使用技巧

1. **首次使用**：
   - 先运行 `python update_market_data.py --initial-sync` 同步数据
   - 启动服务器
   - 在网页中测试"Run Decision"

2. **日常使用**：
   - 保持数据更新：`python update_market_data.py`（后台运行）
   - 打开网页进行决策
   - 使用自动运行功能进行定期决策

3. **调试**：
   - 查看浏览器控制台（F12）查看错误
   - 查看服务器终端日志
   - 使用Offline模式测试流程

---

## 🚀 快速开始示例

```bash
# 1. 初始同步数据（首次运行）
python update_market_data.py --initial-sync

# 2. 启动服务器
uvicorn fastapi_app:app --reload

# 3. 在浏览器打开
# http://localhost:8000

# 4. 在网页中：
# - 点击"Run Decision"按钮
# - 查看包含技术分析的决策结果
```

---

**现在你可以通过网页界面方便地使用包含技术分析的决策系统了！** 🎉



