# 技术分析Agent集成说明

## ✅ 已完成的工作

### 1. 完善技术分析Agent

**新增功能：**

- ✅ **更多技术指标**：
  - KDJ指标（随机指标）
  - ADX（平均趋向指标）- 趋势强度
  - 价格动量（Momentum）
  - 变化率（ROC）
  - 价格通道（Price Channel）

- ✅ **模式识别**：
  - 布林带位置识别
  - KDJ超买超卖识别
  - KDJ金叉死叉识别
  - MACD信号识别
  - 价格突破通道识别
  - 成交量异常识别

- ✅ **综合市场信号**：
  - 自动计算看涨/看跌信号数量
  - 综合信号方向（看涨/看跌/中性）
  - 信号强度评估
  - 趋势强度（基于ADX）

- ✅ **结构化输出**：
  - `generate_analysis_report()`: 生成详细的分析报告（文本格式）
  - `get_structured_summary()`: 生成结构化摘要（JSON格式）

### 2. 修改Prompt模板

**改进点：**

- ✅ 添加技术分析报告区块到prompt
- ✅ 增强决策指导，包括：
  - 考虑技术分析信号
  - 使用支撑阻力位设置止盈止损
  - 根据波动率调整仓位大小
  - 处理冲突信号的保守策略

### 3. 集成到run_decision.py

**集成方式：**

- ✅ 自动根据symbol和时间框架创建技术分析Agent
- ✅ 生成技术分析报告

**数据准备**：
- 基础功能需要1h数据：`python update_market_data.py --initial-sync`
- 回测系统需要15m数据：`python update_market_data.py --initial-sync --timeframe 15m --days 365`
- ✅ 传递给prompt渲染函数
- ✅ 错误处理：如果技术分析失败，继续执行但不包含分析报告

### 4. 集成到FastAPI

**API集成：**

- ✅ `/api/decision/run` 端点自动生成技术分析
- ✅ 在响应消息中显示技术分析状态
- ✅ 错误处理确保API稳定性

---

## 📊 技术分析报告内容

### 综合市场信号

- **信号方向**：看涨/看跌/中性
- **信号强度**：强/中/弱
- **看涨信号数**：技术指标中看涨信号的数量
- **看跌信号数**：技术指标中看跌信号的数量
- **ADX**：趋势强度指标（>25为强趋势，>20为中等趋势）

### 趋势分析

- **当前趋势**：上升趋势/下降趋势/横盘震荡
- **趋势强度**：强/弱/中性
- **当前价格**
- **EMA20/EMA50**：指数移动平均线
- **价格相对EMA20的偏离度**
- **RSI(14)**：相对强弱指标，标注超买/超卖状态

### 支撑阻力分析

- **阻力位**：最近的阻力水平及距离
- **支撑位**：最近的支撑水平及距离
- **当前价格**

### 波动率分析

- **ATR(14)**：平均真实波幅
- **波动率趋势**：上升/下降/稳定
- **布林带宽度**：波动率指标
- **布林带位置**：价格在布林带中的位置（0=下轨，1=上轨）

### 成交量分析

- **当前成交量**
- **成交量比率**：相对于20日平均成交量的倍数

### 技术指标信号

- **MACD**：MACD线、信号线、柱状图
- **KDJ**：K值、D值、J值

### 形态识别

- 自动识别当前市场的技术形态
- 包括：超买超卖、金叉死叉、突破、成交量异常等

---

## 🚀 使用方法

### CLI方式

```bash
# 运行决策（自动包含技术分析）
python run_decision.py --live-market

# 指定交易对和时间框架
python run_decision.py --symbol BTC --timeframe 1h --live-market

# 使用不同策略
python run_decision.py --strategy aggressive --live-market
```

### API方式

```python
import requests

# 发送决策请求
response = requests.post(
    "http://localhost:8000/api/decision/run",
    json={
        "symbol": "BTC",
        "timeframe": "1h",
        "strategy_type": "balanced",
        "live_market": True,
        "save_output": True,
    }
)

result = response.json()
print(result["prompt"])  # 包含技术分析报告
```

### 直接使用技术分析Agent

```python
from src.data.technical_analysis_agent import TechnicalAnalysisAgent

# 创建Agent
agent = TechnicalAnalysisAgent(
    symbol="BTC/USDT:USDT",
    timeframe="1h",
    limit=500,
)

# 生成文本报告
report = agent.generate_analysis_report()
print(report)

# 获取结构化数据
summary = agent.get_structured_summary()
print(summary["market_signal"])  # 市场信号
print(summary["trend"])  # 趋势信息
```

---

## 🔧 配置说明

### 默认配置

- **交易对**：根据 `args.symbol` 或默认 "BTC"
- **时间框架**：根据 `args.timeframe` 或配置中的 `market_timeframe`（默认 "1h"）
- **数据量**：最近500根K线

### 自定义配置

在 `src/config.py` 中配置：

```python
market_symbols: dict[str, str] = {
    "BTC": "BTC/USDT:USDT",
    "ETH": "ETH/USDT:USDT",
    # 添加更多交易对
}
market_timeframe: str = "1h"  # 默认时间框架
```

---

## ⚠️ 注意事项

### 数据要求

- **数据库必须有数据**：运行决策前，确保已执行初始同步
- **数据量要求**：建议至少500根K线以确保技术指标计算准确
- **时间框架一致性**：确保数据库中的时间框架与请求的时间框架一致

**数据下载命令**：
```bash
# 下载1h数据（基础功能）
python update_market_data.py --initial-sync --days 365

# 下载15m数据（回测系统需要）
python update_market_data.py --initial-sync --timeframe 15m --days 365

# 查看数据统计
python update_market_data.py --stats
```

**注意**：
- 基础功能（技术分析、决策）需要1h数据
- 回测系统需要15m数据作为基准周期
- 15m数据量较大：365天约35,040根K线

### 错误处理

- **数据库无数据**：系统会输出警告，但不影响决策流程（只是不包含技术分析）
- **指标计算失败**：会捕获异常并继续执行
- **数据不足**：某些指标（如EMA200）可能需要更多数据，系统会自动降级

### 性能考虑

- **首次加载**：技术分析需要从数据库加载数据并计算指标，可能需要1-2秒
- **缓存**：技术分析结果不缓存，每次都重新计算（确保数据最新）
- **并发**：多个请求同时运行不会冲突（每个请求创建独立的Agent实例）

---

## 📈 技术分析对决策的影响

### 看涨信号

当技术分析显示看涨信号时，LLM可能会：
- 考虑开多仓（OPEN_LONG）
- 提高信心度（confidence）
- 设置更高的止盈目标
- 设置更宽松的止损（如果趋势很强）

### 看跌信号

当技术分析显示看跌信号时，LLM可能会：
- 考虑开空仓（OPEN_SHORT）或平多仓
- 降低仓位大小
- 设置更严格的止损
- 提高风险意识

### 中性信号

当技术分析显示中性信号时，LLM可能会：
- 倾向于HOLD
- 降低仓位大小
- 保持更保守的策略

### 冲突信号

当技术指标显示冲突时：
- LLM会收到提示，采取更保守的策略
- 可能会选择HOLD等待更明确的信号
- 可能会降低仓位大小和信心度

---

## 🐛 故障排查

### 问题1：技术分析生成失败

**症状**：日志显示"Failed to generate technical analysis"

**可能原因**：
- 数据库中没有对应交易对和时间框架的数据
- 数据库文件不存在或路径错误

**解决方案**：
```bash
# 检查数据库统计
python update_market_data.py --stats

# 执行初始同步（1h数据）
python update_market_data.py --initial-sync

# 如果使用回测系统，需要下载15m数据
python update_market_data.py --initial-sync --timeframe 15m --days 365
```

### 问题2：某些指标显示N/A

**症状**：技术分析报告中某些指标显示为N/A

**可能原因**：
- 数据量不足（例如EMA200需要至少200根K线）
- 计算过程中出现异常

**解决方案**：
- 增加数据库中的数据量（运行初始同步时增加天数）
- 检查日志查看详细错误信息

### 问题3：技术分析与市场快照不一致

**症状**：技术分析中的价格与市场快照中的价格不同

**可能原因**：
- 技术分析使用的是历史数据（可能是几小时前的）
- 市场快照是实时数据

**说明**：这是正常现象。技术分析基于历史数据计算指标，而市场快照是实时价格。LLM会综合考虑两者。

---

## 📚 API参考

### TechnicalAnalysisAgent

#### 方法

- `load_data()`: 从数据库加载数据
- `calculate_indicators()`: 计算所有技术指标
- `analyze_trend()`: 分析趋势
- `identify_support_resistance()`: 识别支撑阻力位
- `analyze_volatility()`: 分析波动率
- `identify_patterns()`: 识别技术形态
- `get_market_signal()`: 获取综合市场信号
- `generate_analysis_report()`: 生成文本报告
- `get_structured_summary()`: 获取结构化摘要

---

## 🎯 下一步优化建议

1. **添加更多指标**：
   - OBV（能量潮）
   - CCI（商品通道指数）
   - 威廉指标（Williams %R）

2. **模式识别增强**：
   - 图表形态识别（头肩顶、双底等）
   - K线形态识别（锤子线、十字星等）

3. **多时间框架分析**：
   - 同时分析1h、4h、1d等多个时间框架
   - 综合多时间框架信号

4. **历史表现分析**：
   - 分析历史信号的成功率
   - 根据历史表现调整信号权重

---

**系统现在已经完全集成技术分析，LLM决策时会自动考虑技术分析信号！**



